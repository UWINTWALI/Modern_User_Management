{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{% if form.instance.pk %}Edit{% else %}Add{% endif %} User</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- js style files -->
    <script src="{% static 'js/styles.js' %}"></script>
    <script src="{% static 'js/userform.js' %}"></script>


    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <style>
        .hidden{
            display: none;
        }
   
    </style>
</head>

<body>
    <div class="container mt-5">

        <!-- Modal -->
        <div class="modal fade" id="AddEditModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg-custom">
                <div class="modal-content w-8">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalLabel">{% if form.instance.pk %}Edit{% else %}Add{% endif %} User
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" enctype="multipart/form-data" id="userForm">
                            {% csrf_token %}

                            <!-- PERSONAL INFORMATION SECTION -->
                            <div class="personal-info-container">
                                <h3>Personal Information</h3>
                                <div class="personal-info-content">
                                    <div class="mb-3">
                                        {{ form.first_name }}
                                    </div>
                                    <div class="mb-3">
                                        {{ form.last_name }}
                                    </div>
                            
                                    <div class="mb-3">
                                        {{ form.userid }}
                                    </div>
                            
                                    <div class="mb-3">
                                        {{ form.email }}
                                    </div>
                            
                                    <div class="mb-3">
                                        <label class="form-label">Sex:</label>
                                        {{ form.sex }}
                                    </div>
                            
                                    <div class="mb-3">
                                        <label class="form-label">Profile Picture:</label>
                                        {{ form.profile_picture }}
                                    </div>
                                </div>
                            </div>

                            
                            <div class="mb-3 form-check">
                                {{ form.is_foreigner }}
                                <label class="form-check-label" for="id_is_foreigner">Is a Foreigner?</label>
                            </div>
                            
                            <!-- Foreign Location Field -->
                            <div id="foreignLocationField"
                            class="mb-3 {% if not form.instance.is_foreigner %}hidden{% endif %}">
                            <label class="form-label">Foreign Location</label>
                            {{ form.foreign_location }}
                            </div>
                            
                            <!-- Local Location Fields -->
                            <div id="localLocationFields" {% if form.instance.is_foreigner %}class="hidden" {% endif %}>
                                <div class="residence-info-container">
                                    <h3>Resisence Information</h3>
                                    <div class="residence-info-content">
                                        <div class="mb-3">
                                            <label class="form-label" for="id_country"></label>                                            
                                            {{ form.country }}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label" for="id_province"></label>
                                            {{ form.province }}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label" for="id_district"></label>
                                            {{ form.district }}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label" for="id_sector"></label>
                                            {{ form.sector }}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label" for="id_cell"></label>
                                            {{ form.cell }}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label" for="id_village"></label>
                                            {{ form.village }}
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>        
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

    // INsert JS for selecting the location____________________________________________________________________________
    function populateDropdown(selectElement, options) {
    selectElement.innerHTML = '<option value="">Select</option>';
    options.forEach(option => {
      const opt = document.createElement('option');
      opt.value = option;
      opt.textContent = option;
      selectElement.appendChild(opt);
    });
  }

  document.addEventListener("DOMContentLoaded", function() {
    const countrySelect = document.getElementById("id_country");
    const provinceSelect = document.getElementById("id_province");
    const districtSelect = document.getElementById("id_district");
    const sectorSelect = document.getElementById("id_sector");
    const cellSelect = document.getElementById("id_cell");
    const villageSelect = document.getElementById("id_village");

    // Load JSON data from file
    fetch("{% static 'json/rwanda_geo.json' %}") 
      .then(response => response.json())
      .then(data => {
        const locationMap = data;

        // Populate the Country dropdown
        populateDropdown(countrySelect, Object.keys(locationMap));

        countrySelect.addEventListener("change", function() {
          // Populate the Province dropdown based on the selected country
          const countryValue = this.value;
          if (countryValue) {
            populateDropdown(provinceSelect, Object.keys(locationMap[countryValue]));
          } else {
            populateDropdown(provinceSelect, []);
          }
        //   districtSelect.innerHTML = sectorSelect.innerHTML = cellSelect.innerHTML = villageSelect.innerHTML = '<option value="">Select</option>';
        });

        provinceSelect.addEventListener("change", function() {
          // Populate the District dropdown based on the selected province
          const countryValue = countrySelect.value;
          const provinceValue = this.value;
          if (provinceValue) {
            populateDropdown(districtSelect, Object.keys(locationMap[countryValue][provinceValue]));
          } else {
            populateDropdown(districtSelect, []);
          }
        //   sectorSelect.innerHTML = cellSelect.innerHTML = villageSelect.innerHTML = '<option value="">Select</option>';
        });

        districtSelect.addEventListener("change", function() {
          // Populate the Sector dropdown based on the selected district
          const countryValue = countrySelect.value;
          const provinceValue = provinceSelect.value;
          const districtValue = this.value;
          if (districtValue) {
            populateDropdown(sectorSelect, Object.keys(locationMap[countryValue][provinceValue][districtValue]));
          } else {
            populateDropdown(sectorSelect, []);
          }
        //   cellSelect.innerHTML = villageSelect.innerHTML = '<option value="">Select</option>';
        });

        sectorSelect.addEventListener("change", function() {
          // Populate the Cell dropdown based on the selected sector
          const countryValue = countrySelect.value;
          const provinceValue = provinceSelect.value;
          const districtValue = districtSelect.value;
          const sectorValue = this.value;
          if (sectorValue) {
            populateDropdown(cellSelect, Object.keys(locationMap[countryValue][provinceValue][districtValue][sectorValue]));
          } else {
            populateDropdown(cellSelect, []);
          }
        //   villageSelect.innerHTML = '<option value="">Select</option>';
        });

        cellSelect.addEventListener("change", function() {
          // Populate the Village dropdown based on the selected cell
          const countryValue = countrySelect.value;
          const provinceValue = provinceSelect.value;
          const districtValue = districtSelect.value;
          const sectorValue = sectorSelect.value;
          const cellValue = this.value;
          if (cellValue) {
            const villages = locationMap[countryValue][provinceValue][districtValue][sectorValue][cellValue];
            populateDropdown(villageSelect, villages || []);
          } else {
            populateDropdown(villageSelect, []);
          }
         });
        })
        .catch(error => console.error('Error loading JSON:', error));
    });


        // END of selection js_____________________________________________________________________________________________        
    </script>
</body>

</html>